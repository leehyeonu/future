<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Future Path – Dual Timeline Simulator</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.159.0/examples/js/controls/OrbitControls.js"></script>
<style>
:root{--bg:#071028;--panel:#071833;--muted:#98a6d8;--text:#eef6ff;--accent:#7bdff6;--accent2:#c77dff;}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#020617 0%, #041226 100%);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
.container{max-width:1400px;margin:18px auto;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
.brand{display:flex;gap:12px;align-items:center}
.title{font-weight:800;font-size:18px}
.controlsBar{display:flex;gap:8px;align-items:center}
.card{background:linear-gradient(180deg,#07162a,#04102a);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03)}
.layout{display:grid;grid-template-columns:360px 1fr;gap:14px}
@media(max-width:1100px){.layout{grid-template-columns:1fr}}
.leftPanel .card{margin-bottom:12px}
.formRow{margin-top:8px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
select,input[type=range],input[type=number],input[type=text]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:8px;align-items:center}
.btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#041028;font-weight:700;cursor:pointer}
.btn.alt{background:linear-gradient(90deg,#34d399,#60a5fa);color:#041028}
.twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.sceneWrap{height:420px;border-radius:12px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,#08142a,#021024)}
.sceneTitle{position:absolute;left:12px;top:12px;background:rgba(2,6,20,0.5);padding:6px 8px;border-radius:8px;font-weight:700;color:var(--muted);z-index:3}
.hud{position:absolute;right:12px;top:12px;background:rgba(2,6,20,0.5);padding:8px;border-radius:8px;font-size:13px;color:var(--muted);z-index:3}
.kpiGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
.kpi{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;text-align:center}
.tlControls{display:flex;gap:8px;align-items:center;margin-top:10px}
.timebar{width:100%;height:10px;background:linear-gradient(90deg,#0b1530,#07102b);border-radius:999px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
.timeProgress{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#7bdff6,#c77dff);width:0%}
.legend{display:flex;gap:12px;align-items:center;margin-top:8px}
.legend .item{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px}
.footer{margin-top:14px;text-align:center;color:var(--muted);font-size:12px}
.smallBtn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand"><div class="title">Future Path — Dual Timeline Simulator</div></div>
    <div class="controlsBar">
      <button class="smallBtn" id="resetBtn">리셋</button>
      <button class="btn" id="startBtn">시작</button>
      <button class="btn alt" id="pauseBtn">일시정지</button>
    </div>
  </div>

  <div class="layout">
    <div class="leftPanel">
      <div class="card">
        <label>시나리오 이름</label>
        <input type="text" id="scenarioName" value="사용자 시나리오 A" />

        <div class="formRow"><label>기술 발전 속도</label><select id="tech"><option value="slow">느림</option><option value="medium" selected>보통</option><option value="fast">빠름</option><option value="hyper">초가속</option></select></div>
        <div class="formRow"><label>자동화 비율(목표)</label><input type="range" id="auto" min="0" max="1" step="0.01" value="0.4"></div>
        <div class="formRow"><label>협업 강도</label><select id="collab"><option value="low">낮음</option><option value="medium" selected>중간</option><option value="high">높음</option></select></div>
        <div class="formRow"><label>교육/업스킬 수준</label><select id="edu"><option value="low">낮음</option><option value="medium" selected>중간</option><option value="high">높음</option></select></div>
        <div class="formRow"><label>에너지 체계</label><select id="energy"><option value="fossil">화석</option><option value="nuclear">원자력</option><option value="renewable" selected>재생</option><option value="fusion">퓨전</option></select></div>
        <div class="formRow"><label>환경 지속가능성</label><input type="range" id="env" min="0" max="1" step="0.01" value="0.6"></div>

        <div class="formRow" style="margin-top:12px">
          <label class="small">Firebase (옵션)</label>
          <input type="text" id="fbApiKey" placeholder="apiKey"><input type="text" id="fbProjectId" placeholder="projectId" style="margin-top:8px">
          <div style="margin-top:8px"><input type="checkbox" id="useFb"> Firestore 'jobs' 컬렉션 사용</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="small">타임라인 설정</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input type="number" id="startYear" value="1700" style="width:100%"><input type="number" id="endYear" value="2100" style="width:100%">
        </div>
        <div class="small" style="margin-top:8px">에포크(과거→산업→디지털→현재→미래)를 자동으로 생성합니다.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="small">설명</div>
        <div class="small" style="margin-top:8px">왼쪽 패널은 사용자가 조정하는 시나리오, 오른쪽 패널은 기준(현재) 시나리오입니다. 시작을 누르면 동일한 타임라인 동안 두 패널이 병렬로 변합니다.</div>
      </div>
    </div>

    <div class="rightPanel">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="card sceneWrap" id="leftSceneWrap">
          <div class="sceneTitle">사용자 시나리오</div>
          <div id="leftThree" style="width:100%;height:100%"></div>
          <div class="hud" id="leftHud">자동화 0% • 협업 0%</div>
        </div>
        <div class="card sceneWrap" id="rightSceneWrap">
          <div class="sceneTitle">기준 시나리오 (현재)</div>
          <div id="rightThree" style="width:100%;height:100%"></div>
          <div class="hud" id="rightHud">자동화 0% • 협업 0%</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="tlControls">
          <div class="small">타임라인 진행</div>
          <div style="flex:1"></div>
          <div class="small" id="yearLabel">연도: —</div>
        </div>
        <div class="timebar" style="margin-top:8px"><div class="timeProgress" id="timeProgress"></div></div>
        <div class="legend">
          <div class="item"><span class="legendDot" style="background:#7bdff6"></span>인간</div>
          <div class="item"><span class="legendDot" style="background:#c77dff"></span>로봇</div>
          <div class="item"><span class="legendDot" style="background:#ffd166"></span>드론</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="twoCols">
          <div><canvas id="barChart" height="220"></canvas></div>
          <div><canvas id="radarChart" height="220"></canvas></div>
        </div>
      </div>

    </div>
  </div>

  <div class="footer">제작: Future Path • 버전 2.0 • 생성일: 2025-08-16</div>
</div>

<script>
/* High-level single-file dual-scene simulator
   - left scenario: user-controlled parameters
   - right scenario: baseline/current parameters (fixed)
   - timeline animates epochs from past to future (interpolated)
   - high-quality visuals are approximated with procedural geometry, emissive lighting, and smooth transitions
   - optional Firestore data ingestion supported but not required
*/

// ---------- Utility & model (same flavor as earlier but extended) ----------
function clamp(x,lo,hi){return Math.min(Math.max(x,lo),hi);}
function lerp(a,b,t){return a + (b-a)*t;}
function lerpColor(c1,c2,t){ return { r: lerp(c1.r,c2.r,t), g: lerp(c1.g,c2.g,t), b: lerp(c1.b,c2.b,t) }; }
function colorToHex(c){ const r=Math.round(c.r*255), g=Math.round(c.g*255), b=Math.round(c.b*255); return (r<<16)|(g<<8)|b; }

const COEFFS = { tech_speed:{slow:0.03,medium:0.07,fast:0.12,hyper:0.2}, education:{low:0.9,medium:0.75,high:0.55}, regulation:{weak:1,moderate:0.85,strong:0.7}, collab:{low:0.1,medium:0.3,high:0.55} };

// Baseline "current" params derived from today's defaults
const BASELINE_PARAMS = { tech:'medium', edu:'medium', reg:'moderate', collab:'medium', bess:'medium', energy:'renewable', env:0.6, auto:0.4 };

// Example epochs from past → future (parameterized)
function makeEpochs(startYear, endYear, userParams, baselineParams){
  // fixed epoch points: agriculture, industrial, digital, present, future target
  const epochs = [
    { year: startYear, label:'농업혁명', tech:'slow', auto:0.02, collab:'low', edu:'low', energy:'fossil', env:0.7 },
    { year: Math.round(startYear + (endYear-startYear)*0.25), label:'산업혁명', tech:'slow', auto:0.15, collab:'low', edu:'low', energy:'fossil', env:0.55 },
    { year: Math.round(startYear + (endYear-startYear)*0.55), label:'디지털혁명', tech:'medium', auto:0.32, collab:'medium', edu:'medium', energy:'fossil', env:0.5 },
    { year: Math.round(endYear*0.8), label:'현재', tech:BASELINE_PARAMS.tech, auto:BASELINE_PARAMS.auto, collab:BASELINE_PARAMS.collab, edu:BASELINE_PARAMS.edu, energy:BASELINE_PARAMS.energy, env:BASELINE_PARAMS.env },
    { year: endYear, label:'미래(목표)', tech:userParams.tech, auto:parseFloat(userParams.auto), collab:userParams.collab, edu:userParams.edu, energy:userParams.energy, env:parseFloat(userParams.env) }
  ];
  return epochs;
}

// Interpolate epoch values for a given t (0..1 between epochs)
function interpEpochValue(a,b,t){
  // for numeric
  if(typeof a === 'number' && typeof b === 'number') return lerp(a,b,t);
  // for categorical (tech, collab, edu, energy), choose based on t threshold but can blend via mapping
  const map = { slow:0, medium:0.33, fast:0.66, hyper:1 };
  if(a in map && b in map){
    const va = map[a], vb = map[b];
    const v = lerp(va,vb,t);
    // map back to nearest category
    const keys = Object.keys(map);
    let best = keys[0], bestDiff = Math.abs(v-map[best]);
    for(let k of keys){ const d = Math.abs(v-map[k]); if(d<bestDiff){ best=k; bestDiff=d; } }
    return best;
  }
  return t<0.5? a : b;
}

// Basic projection model per job (simplified composite)
function projectJobs(jobs, years, params){
  // similar to earlier projection but lighter for performance
  const g = COEFFS.tech_speed[params.tech] * COEFFS.regulation[params.reg];
  return jobs.map(row=>{
    const cap = (row.max_automation_cap||0.8) * (params.reg==='weak'?0.95:(params.reg==='moderate'?0.85:0.75));
    const projAuto = cap * Math.min(1, row.current_automation + g * Math.sqrt(years) * (params.tech==='hyper'?1.8:1));
    const skill = ((row.creativity_requirement||0)+(row.social_intelligence_requirement||0)+(row.remote_feasibility||0))/3;
    const collShare = Math.min(0.95, COEFFS.collab[params.collab] * (0.6 + 0.8*skill));
    const collaborated = projAuto * collShare;
    const baseDisp = 0.6 + 0.6*(row.routine_task_share||0) + 0.3*(row.physical_task_intensity||0) - 0.35*(row.union_protection||0) - 0.25*(row.wage_level||0);
    const dispMult = Math.min(1.5, COEFFS.education[params.edu] * baseDisp);
    let displaced = Math.min(1, Math.max(0, projAuto - collaborated) * dispMult);
    const survivors = 1 - displaced;
    return {...row, proj_automation:projAuto, proj_collab_share:collaborated, proj_displacement_share:displaced, proj_survival_index:survivors};
  });
}

// Demo compact JOBS (can be replaced by Firestore)
let JOBS = [
  { job_category:'Software & Data', current_automation:0.35, max_automation_cap:0.7, routine_task_share:0.45, creativity_requirement:0.75, social_intelligence_requirement:0.5, physical_task_intensity:0.05, ai_tool_adoption:0.7, remote_feasibility:0.9, union_protection:0.1, wage_level:0.65 },
  { job_category:'Manufacturing', current_automation:0.55, max_automation_cap:0.9, routine_task_share:0.75, creativity_requirement:0.3, social_intelligence_requirement:0.3, physical_task_intensity:0.6, ai_tool_adoption:0.55, remote_feasibility:0.2, union_protection:0.35, wage_level:0.35 },
  { job_category:'Healthcare', current_automation:0.22, max_automation_cap:0.55, routine_task_share:0.3, creativity_requirement:0.55, social_intelligence_requirement:0.9, physical_task_intensity:0.3, ai_tool_adoption:0.35, remote_feasibility:0.3, union_protection:0.55, wage_level:0.7 }
];

// ---------- Three.js dual scenes (left/right) ----------
let scenes = { left:{}, right:{} };

function initDualThree(containerId, sceneObj, label){
  const wrap = document.getElementById(containerId);
  const renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
  renderer.setSize(wrap.clientWidth, wrap.clientHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  wrap.appendChild(renderer.domElement);
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, wrap.clientWidth/wrap.clientHeight, 0.1, 200);
  camera.position.set(0,18,34);
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  // lights
  const amb = new THREE.AmbientLight(0xffffff,0.6); scene.add(amb);
  const dir = new THREE.DirectionalLight(0xffffff,0.6); dir.position.set(10,30,10); scene.add(dir);
  // ground
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(120,80), new THREE.MeshStandardMaterial({color:0x041229,roughness:0.95}));
  ground.rotation.x = -Math.PI/2; ground.position.y = 0; scene.add(ground);
  // groups
  const buildingGroup = new THREE.Group(), humanGroup = new THREE.Group(), robotGroup = new THREE.Group(), droneGroup = new THREE.Group();
  scene.add(buildingGroup); scene.add(humanGroup); scene.add(robotGroup); scene.add(droneGroup);
  // store
  sceneObj.renderer = renderer; sceneObj.scene = scene; sceneObj.camera = camera; sceneObj.controls = controls;
  sceneObj.groups = { buildingGroup, humanGroup, robotGroup, droneGroup };
  sceneObj.wrap = wrap;
  // initial population
  populateBuildingsScene(sceneObj, 0.3, 'medium');
  updateEntitiesScene(sceneObj, 0.3, 0.2);
  // handle resize
  window.addEventListener('resize', ()=>{ renderer.setSize(wrap.clientWidth, wrap.clientHeight); camera.aspect = wrap.clientWidth/wrap.clientHeight; camera.updateProjectionMatrix(); });
  // animate loop
  (function animate(){
    requestAnimationFrame(animate);
    // update small anims: drones, subtle group rotation
    if(sceneObj.groups.droneGroup){ sceneObj.groups.droneGroup.children.forEach((d,idx)=>{ const t=performance.now()/1000+idx; d.position.x += Math.sin(t*0.9+idx)*0.01; d.position.z += Math.cos(t*1.1+idx)*0.015; d.rotation.y += 0.04; d.position.y = 5 + Math.sin(t*2+idx)*0.4; }); }
    if(sceneObj.groups.humanGroup) sceneObj.groups.humanGroup.rotation.y = Math.sin(performance.now()/6000)*0.02;
    if(sceneObj.groups.robotGroup) sceneObj.groups.robotGroup.rotation.y = -Math.sin(performance.now()/5000)*0.03;
    sceneObj.controls.update();
    sceneObj.renderer.render(sceneObj.scene, sceneObj.camera);
  })();
}

// populate buildings for a scene object
function populateBuildingsScene(sceneObj, automation, techSpeed){
  const g = sceneObj.groups.buildingGroup;
  // clear
  while(g.children.length) g.remove(g.children[0]);
  const density = Math.round(8 + automation*14 + (techSpeed==='fast'?6:(techSpeed==='slow'?-2:0)));
  const spacing = 6;
  for(let i=0;i<density;i++){
    const cols = 6;
    const row = Math.floor(i/cols), col = i%cols;
    const x = (col - cols/2) * spacing;
    const z = (row - Math.floor(density/cols)/2) * spacing - 8;
    const base = 4 + automation*28 + (techSpeed==='fast'?8:(techSpeed==='slow'?-4:0));
    const height = Math.max(3, base * (0.6 + Math.random()*0.8));
    const geom = new THREE.BoxGeometry(4, height, 4);
    const neon = clamp(automation,0,1);
    const color = new THREE.Color().setHSL(0.6 - automation*0.25, 0.6, 0.12 + neon*0.28);
    const mat = new THREE.MeshStandardMaterial({color: color, metalness: 0.3, roughness: 0.5});
    const m = new THREE.Mesh(geom, mat);
    m.position.set(x, height/2, z);
    if(Math.random()>0.4){
      mat.emissive = new THREE.Color().setHSL(0.12 + automation*0.1, 0.8, 0.6);
      mat.emissiveIntensity = 0.2 + automation*0.8;
    }
    g.add(m);
  }
}

// helpers to create human/robot/drone meshes
function makeHumanMesh(){ const geom = new THREE.SphereGeometry(0.8,16,12); const mat = new THREE.MeshStandardMaterial({color:0x8beaf6,metalness:0.1,roughness:0.6}); return new THREE.Mesh(geom,mat); }
function makeRobotMesh(collab){ const geom = new THREE.BoxGeometry(1.4,1.4,1.4); const hue = 0.7 - collab*0.25; const col = new THREE.Color().setHSL(hue,0.7,0.55); const mat = new THREE.MeshStandardMaterial({color:col,metalness:0.8,roughness:0.2}); return new THREE.Mesh(geom,mat); }
function makeDroneMesh(idx){ const geom = new THREE.ConeGeometry(0.3,0.8,8); const mat = new THREE.MeshStandardMaterial({color:0xffd166,emissive:0xffd166}); const m = new THREE.Mesh(geom,mat); m.rotation.x = Math.PI; m.userData = { idx }; return m; }

function updateEntitiesScene(sceneObj, automation, collab){
  const humans = Math.max(1, Math.round(10 * (1 - automation)));
  const robots = Math.max(1, Math.round(10 * automation));
  const gH = sceneObj.groups.humanGroup, gR = sceneObj.groups.robotGroup, gD = sceneObj.groups.droneGroup;
  while(gH.children.length) gH.remove(gH.children[0]);
  while(gR.children.length) gR.remove(gR.children[0]);
  while(gD.children.length) gD.remove(gD.children[0]);
  const width = 36;
  for(let i=0;i<humans;i++){ const m = makeHumanMesh(); const x = -16 + (i+1)/(humans+1)*width; const z = -6 - Math.sin(i)*2; m.position.set(x,0.9,z); gH.add(m); }
  for(let i=0;i<robots;i++){ const m = makeRobotMesh(collab); const x = -16 + (i+1)/(robots+1)*width; const z = 4 + Math.sin(i)*2; m.position.set(x,0.7,z); gR.add(m); }
  const drones = Math.max(0, Math.round(3 + automation*6));
  for(let i=0;i<drones;i++){ const d = makeDroneMesh(i); const x = -18 + (i+1)/(drones+1)*width; d.position.set(x,5 + (i%3)*1.2, -8 + i%5); gD.add(d); }
}

// ---------- Timeline orchestration ----------
let isPlaying=false, playStart=0, playDuration=20000; // 20s default
let leftEpochs=[], rightEpochs=[];

function buildEpochsAndStart(){
  const startYear = parseInt(document.getElementById('startYear').value||1700,10);
  const endYear = parseInt(document.getElementById('endYear').value||2100,10);
  // user params from controls
  const userParams = { tech: document.getElementById('tech').value, auto: document.getElementById('auto').value, collab: document.getElementById('collab').value, edu: document.getElementById('edu').value, energy: document.getElementById('energy').value, env: document.getElementById('env').value };
  // baseline fixed
  const baselineParams = BASELINE_PARAMS;
  leftEpochs = makeEpochs(startYear, endYear, userParams, baselineParams);
  rightEpochs = makeEpochs(startYear, endYear, baselineParams, baselineParams);
  // prepare play
  playStart = performance.now();
  isPlaying = true;
  requestAnimationFrame(playLoop);
}

function findEpochPair(epochs,tNorm){
  // tNorm 0..1 across full timeline. find segment
  const total = epochs[epochs.length-1].year - epochs[0].year;
  const targetYear = Math.round(epochs[0].year + tNorm*total);
  // find lower and upper epoch indices
  for(let i=0;i<epochs.length-1;i++){
    if(targetYear >= epochs[i].year && targetYear <= epochs[i+1].year){
      const localT = (targetYear - epochs[i].year) / (epochs[i+1].year - epochs[i].year || 1);
      return { i, localT, year: targetYear };
    }
  }
  return { i: epochs.length-2, localT:1, year:epochs[epochs.length-1].year };
}

function interpolateScenario(epochs,tNorm){
  const p = findEpochPair(epochs,tNorm);
  const a = epochs[p.i], b = epochs[p.i+1];
  // produce interpolated params
  return {
    year: p.year,
    tech: interpEpochValue(a.tech,b.tech,p.localT),
    auto: interpEpochValue(a.auto,b.auto,p.localT),
    collab: interpEpochValue(a.collab,b.collab,p.localT),
    edu: interpEpochValue(a.edu,b.edu,p.localT),
    energy: interpEpochValue(a.energy,b.energy,p.localT),
    env: lerp(a.env||0,b.env||0,p.localT)
  };
}

function playLoop(){
  if(!isPlaying) return;
  const now = performance.now();
  const t = (now - playStart) / playDuration; // 0..1
  const clamped = Math.min(1, Math.max(0, t));
  // update progress bar and year label (use leftEpochs timeline)
  document.getElementById('timeProgress').style.width = (clamped*100)+'%';
  const leftState = interpolateScenario(leftEpochs, clamped);
  const rightState = interpolateScenario(rightEpochs, clamped);
  // update scenes visuals and HUDs
  updateEntitiesScene(scenes.left, leftState.auto, mapCollabToNumeric(leftState.collab));
  populateBuildingsScene(scenes.left, leftState.auto, leftState.tech);
  document.getElementById('leftHud').textContent = '연도 ' + leftState.year + ' • 자동화 ' + Math.round(leftState.auto*100) + '% • 협업 ' + leftState.collab;
  updateEntitiesScene(scenes.right, rightState.auto, mapCollabToNumeric(rightState.collab));
  populateBuildingsScene(scenes.right, rightState.auto, rightState.tech);
  document.getElementById('rightHud').textContent = '연도 ' + rightState.year + ' • 자동화 ' + Math.round(rightState.auto*100) + '% • 협업 ' + rightState.collab;
  document.getElementById('yearLabel').textContent = leftState.year;
  // update charts using project model for display (use year delta)
  const yearsFromNow = leftState.year - new Date().getFullYear();
  const leftProj = projectJobs(JOBS, Math.max(0, yearsFromNow), { tech:leftState.tech, reg:'moderate', edu:leftState.edu, collab:leftState.collab, bess:'medium' });
  const rightProj = projectJobs(JOBS, Math.max(0, yearsFromNow), { tech:rightState.tech, reg:'moderate', edu:rightState.edu, collab:rightState.collab, bess:'medium' });
  // for charts we show left vs right by overlaying left's values primarily
  updateChartsForComparison(leftProj, rightProj);
  // progress finished?
  if(clamped >= 1){ isPlaying = false; return; }
  requestAnimationFrame(playLoop);
}

function mapCollabToNumeric(c){
  if(c==='low') return 0.15;
  if(c==='medium') return 0.35;
  if(c==='high') return 0.6;
  return parseFloat(c) || 0.3;
}

// updateChartsForComparison
let barChart, radarChart;
function initCharts(){ const bctx = document.getElementById('barChart'); barChart = new Chart(bctx,{type:'bar',data:{labels:[],datasets:[{label:'왼쪽: 협업',data:[],backgroundColor:'rgba(59,130,246,0.9)'},{label:'오른쪽: 협업',data:[],backgroundColor:'rgba(99,102,241,0.5)'},{label:'왼쪽: 대체',data:[],backgroundColor:'rgba(239,68,68,0.9)'},{label:'오른쪽: 대체',data:[],backgroundColor:'rgba(249,115,22,0.5)'}]},options:{responsive:true,scales:{y:{ticks:{callback:v=>Math.round(v*100)+'%'},suggestedMax:1}},plugins:{legend:{labels:{color:'#cfd7ff'}}}}}); const rctx = document.getElementById('radarChart'); radarChart = new Chart(rctx,{type:'radar',data:{labels:['루틴','육체','창의','사회','원격','민감','노조','임금','도구'],datasets:[{label:'왼쪽 평균',data:Array(9).fill(0),borderColor:'rgba(123,223,246,0.9)',backgroundColor:'rgba(123,223,246,0.12)'},{label:'오른쪽 평균',data:Array(9).fill(0),borderColor:'rgba(199,150,255,0.9)',backgroundColor:'rgba(199,150,255,0.10)'}]},options:{responsive:true,scales:{r:{suggestedMin:0,suggestedMax:1}},plugins:{legend:{labels:{color:'#cfd7ff'}}}}}); }

function updateChartsForComparison(leftProj, rightProj){
  barChart.data.labels = leftProj.map(d=>d.job_category);
  barChart.data.datasets[0].data = leftProj.map(d=>d.proj_collab_share);
  barChart.data.datasets[1].data = rightProj.map(d=>d.proj_collab_share);
  barChart.data.datasets[2].data = leftProj.map(d=>d.proj_displacement_share);
  barChart.data.datasets[3].data = rightProj.map(d=>d.proj_displacement_share);
  barChart.update();
  const avg = (arr,k)=>arr.reduce((s,v)=>s+(v[k]||0),0)/arr.length;
  const leftData = [avg(leftProj,'routine_task_share'), avg(leftProj,'physical_task_intensity'), avg(leftProj,'creativity_requirement'), avg(leftProj,'social_intelligence_requirement'), avg(leftProj,'remote_feasibility')||0.4, avg(leftProj,'data_sensitivity')||0.2, avg(leftProj,'union_protection')||0.2, avg(leftProj,'wage_level')||0.4, avg(leftProj,'ai_tool_adoption')||0.4];
  const rightData = [avg(rightProj,'routine_task_share'), avg(rightProj,'physical_task_intensity'), avg(rightProj,'creativity_requirement'), avg(rightProj,'social_intelligence_requirement'), avg(rightProj,'remote_feasibility')||0.4, avg(rightProj,'data_sensitivity')||0.2, avg(rightProj,'union_protection')||0.2, avg(rightProj,'wage_level')||0.4, avg(rightProj,'ai_tool_adoption')||0.4];
  radarChart.data.datasets[0].data = leftData.map(x=>+x.toFixed(3));
  radarChart.data.datasets[1].data = rightData.map(x=>+x.toFixed(3));
  radarChart.update();
}

// ---------- Wiring UI ----------
document.getElementById('startBtn').addEventListener('click', ()=>{ if(isPlaying) return; buildEpochsAndStart(); });
document.getElementById('pauseBtn').addEventListener('click', ()=>{ isPlaying = !isPlaying; if(isPlaying){ playStart = performance.now() - (parseFloat(document.getElementById('timeProgress').style.width||'0').replace('%','')/100)*playDuration; requestAnimationFrame(playLoop); } });
document.getElementById('resetBtn').addEventListener('click', ()=>{ isPlaying=false; document.getElementById('timeProgress').style.width='0%'; document.getElementById('yearLabel').textContent='—'; initScenesAndCharts(); });

// init scenes and charts
function initScenesAndCharts(){
  initCharts();
  // create left and right scenes
  scenes.left = {}; scenes.right = {};
  initDualThree('leftThree', scenes.left, 'left');
  initDualThree('rightThree', scenes.right, 'right');
  // initial charts
  updateChartsForComparison(projectJobs(JOBS,0,BASELINE_PARAMS), projectJobs(JOBS,0,BASELINE_PARAMS));
}

window.addEventListener('load', ()=>{ initScenesAndCharts(); });

</script>
</body>
</html>
